PASSWORD HASHING TEST SCRIPT
=============================

This script will help you test password hashing compatibility between
the web app and the API.

## TEST 1: Check Database Values
---------------------------------

Run this SQL query to see what's actually stored in the database for
a user that was recently reset:

```sql
SELECT
  username,
  LENGTH(password_salt) as salt_length,
  LEFT(password_salt, 20) as salt_preview,
  LENGTH(password_hash) as hash_length,
  LEFT(password_hash, 20) as hash_preview,
  password_salt,
  password_hash
FROM users
WHERE username = 'YOUR_USERNAME_HERE';
```

Expected values for PBKDF2:
- salt_length: 32
- salt_preview: Should be alphanumeric (e.g., "kJ8mN2pL9qR5sT1vX4yZ")
- hash_length: 64
- hash_preview: Should be lowercase hex (e.g., "a1b2c3d4e5f6789abcde")


## TEST 2: Manual Hash Computation (Xojo Web App)
--------------------------------------------------

Add this test code to your web app to verify hash generation:

```xojo
// Test with known values
Dim testPassword As String = "testpassword123"
Dim testSalt As String = "abcdefghijklmnopqrstuvwxyz012345"

Dim passwordData As New MemoryBlock(testPassword.LenB)
passwordData.StringValue(0, testPassword.LenB) = testPassword

Dim hash As MemoryBlock = Crypto.PBKDF2(testSalt, passwordData, 10000, 32, Crypto.HashAlgorithms.SHA2_256)
Dim hashHex As String = app.EncodeHex(hash)

MessageBox("Test Hash: " + hashHex)
// Expected hash should be consistent each time
```


## TEST 3: Manual Hash Computation (LiveCode API)
--------------------------------------------------

Create a test file test_hash.lc:

```livecode
<?lc
include "API/lib/db-functions.lc"

put "testpassword123" into tPassword
put "abcdefghijklmnopqrstuvwxyz012345" into tSalt

put hashPassword(tPassword, tSalt) into tResult
set the itemDelimiter to ":"
put item 2 of tResult into tHash

put "Test Hash: " & tHash
?>
```

Both systems should produce the EXACT same hash for the same password and salt.


## TEST 4: Check Actual User Password
--------------------------------------

For a user that can't log in via desktop app:

1. Get their password_hash and password_salt from database
2. In Xojo, compute hash with stored salt:
   ```xojo
   Dim storedSalt As String = "..." // from database
   Dim testPassword As String = "..." // the password you know

   Dim passwordData As New MemoryBlock(testPassword.LenB)
   passwordData.StringValue(0, testPassword.LenB) = testPassword

   Dim hash As MemoryBlock = Crypto.PBKDF2(storedSalt, passwordData, 10000, 32, Crypto.HashAlgorithms.SHA2_256)
   Dim hashHex As String = app.EncodeHex(hash)

   MessageBox("Computed: " + hashHex + EndOfLine + "Stored: " + storedHashFromDB)
   ```

3. Compare with stored password_hash - they should match exactly


## TEST 5: Check API Logs
--------------------------

After attempting to log in via desktop app, check your web server error logs
for the debug output. You should see:

```
=== AUTH DEBUG ===
Username: testuser
Salt length: 32
Salt value: kJ8mN2pL9qR5sT1vX4yZ7bC3dF6gH0jK
Hash length: 64
Hash value (first 20 chars): a1b2c3d4e5f6789abcde
Password length: 12
Format: separate salt column (PBKDF2)
Full hash format length: 97
==================
```

If login fails, you'll also see:
```
LOGIN FAILED for user: testuser
Attempting manual hash computation...
Computed hash (first 20): [computed value]
Stored hash (first 20): [stored value]
Hashes match: false
```


## COMMON ISSUES
----------------

1. **Salt length is 64 instead of 32**
   - Old hex-encoded salt format
   - User needs to reset password again with updated web app

2. **Hash doesn't match**
   - Check if both systems use same iteration count (10000)
   - Check if both use SHA2_256
   - Check case sensitivity (hashes should be lowercase)

3. **Salt contains non-alphanumeric characters**
   - Old format, needs password reset with updated code

4. **Password_salt is NULL or empty**
   - Legacy SHA-256 format (no PBKDF2)
   - User needs to reset password
