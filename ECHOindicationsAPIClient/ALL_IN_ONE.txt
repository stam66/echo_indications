// ============================================================
// ECHO INDICATIONS API CLIENT - ALL IN ONE FILE
// ============================================================
// Copy each section below into separate Xojo Modules
// Total: 3 Modules + 1 Test Code
// ============================================================


// ============================================================
// MODULE 1: AppConfig
// ============================================================
// Insert → Module, name it "AppConfig", paste this:

#tag Module
Protected Module AppConfig
	#tag Constant, Name = API_BASE_URL, Type = String, Dynamic = False, Default = \"https://api.echoindications.org", Scope = Protected
	#tag EndConstant

	#tag Constant, Name = API_TIMEOUT_SECONDS, Type = Integer, Dynamic = False, Default = \"30", Scope = Protected
	#tag EndConstant

	#tag Constant, Name = APP_NAME, Type = String, Dynamic = False, Default = \"ECHO Indications", Scope = Protected
	#tag EndConstant

	#tag Constant, Name = APP_VERSION, Type = String, Dynamic = False, Default = \"1.0", Scope = Protected
	#tag EndConstant

	#tag Constant, Name = TOKEN_EXPIRY_MINUTES, Type = Integer, Dynamic = False, Default = \"30", Scope = Protected
	#tag EndConstant

	#tag Constant, Name = TOKEN_REFRESH_BUFFER_MINUTES, Type = Integer, Dynamic = False, Default = \"5", Scope = Protected
	#tag EndConstant

	#tag Constant, Name = DEBUG_MODE, Type = Boolean, Dynamic = False, Default = \"True", Scope = Protected
	#tag EndConstant
End Module
#tag EndModule


// ============================================================
// MODULE 2: APIClient
// ============================================================
// Insert → Module, name it "APIClient", paste this:

#tag Module
Protected Module APIClient
	#tag Method, Flags = &h0
		Function Get(endpoint As String, action As String, params As Dictionary = Nil) As Dictionary
		  Var url As String = BuildURL(endpoint, action, params)

		  If AppConfig.DEBUG_MODE Then
		    System.DebugLog("APIClient.Get: " + url)
		  End If

		  Try
		    Var socket As New URLConnection
		    socket.RequestHeader("User-Agent") = AppConfig.APP_NAME + "/" + AppConfig.APP_VERSION
		    socket.RequestHeader("Accept") = "application/json"

		    If AuthManager.IsAuthenticated Then
		      socket.RequestHeader("Authorization") = AuthManager.GetAuthHeader
		    End If

		    socket.ConnectionTimeout = AppConfig.API_TIMEOUT_SECONDS

		    Var response As String = socket.SendSync("GET", url)

		    Var httpStatus As Integer = socket.HTTPStatusCode
		    If httpStatus <> 200 Then
		      Return CreateErrorResponse("HTTP " + httpStatus.ToString + ": " + response)
		    End If

		    Return ParseResponse(response)

		  Catch err As IOException
		    Return CreateErrorResponse("Network error: " + err.Message)
		  Catch err As RuntimeException
		    Return CreateErrorResponse("Request failed: " + err.Message)
		  End Try
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Function Post(endpoint As String, action As String, data As Dictionary) As Dictionary
		  Var url As String = BuildURL(endpoint, action, Nil)

		  If AppConfig.DEBUG_MODE Then
		    System.DebugLog("APIClient.Post: " + url)
		  End If

		  Try
		    Var socket As New URLConnection
		    socket.RequestHeader("User-Agent") = AppConfig.APP_NAME + "/" + AppConfig.APP_VERSION
		    socket.RequestHeader("Content-Type") = "application/json"
		    socket.RequestHeader("Accept") = "application/json"

		    If AuthManager.IsAuthenticated Then
		      socket.RequestHeader("Authorization") = AuthManager.GetAuthHeader
		    End If

		    socket.ConnectionTimeout = AppConfig.API_TIMEOUT_SECONDS

		    Var jsonData As String = GenerateJSON(data, False)

		    Var response As String = socket.SendSync("POST", url, jsonData)

		    Var httpStatus As Integer = socket.HTTPStatusCode

		    Select Case httpStatus
		    Case 200, 201
		      // Success
		    Case 401
		      AuthManager.Logout
		      Return CreateErrorResponse("Authentication required. Please log in again.")
		    Case 429
		      Return CreateErrorResponse("Rate limit exceeded. Please wait and try again.")
		    Case 500, 502, 503
		      Return CreateErrorResponse("Server error. Please try again later.")
		    Else
		      Return CreateErrorResponse("HTTP " + httpStatus.ToString + ": " + response)
		    End Select

		    Return ParseResponse(response)

		  Catch err As IOException
		    Return CreateErrorResponse("Network error: " + err.Message)
		  Catch err As RuntimeException
		    Return CreateErrorResponse("Request failed: " + err.Message)
		  End Try
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Function IsConnected() As Boolean
		  Try
		    Var socket As New URLConnection
		    socket.ConnectionTimeout = 5

		    Var url As String = AppConfig.API_BASE_URL + "/auth.lc?action=refresh"
		    Var response As String = socket.SendSync("GET", url)

		    Return True

		  Catch err As RuntimeException
		    Return False
		  End Try
		End Function
	#tag EndMethod

	#tag Method, Flags = &h21
		Private Function BuildURL(endpoint As String, action As String, params As Dictionary) As String
		  Var url As String = AppConfig.API_BASE_URL + "/" + endpoint + "?action=" + action

		  If params <> Nil Then
		    For Each key As Variant In params.Keys
		      Var value As Variant = params.Value(key)
		      url = url + "&" + key.StringValue + "=" + EncodeURLComponent(value.StringValue)
		    Next
		  End If

		  Return url
		End Function
	#tag EndMethod

	#tag Method, Flags = &h21
		Private Function ParseResponse(json As String) As Dictionary
		  Try
		    Var result As New Dictionary
		    Var parsed As Variant = ParseJSON(json)

		    If parsed IsA Dictionary Then
		      result = Dictionary(parsed)
		      Return result
		    Else
		      Return CreateErrorResponse("Invalid JSON response format")
		    End If

		  Catch err As RuntimeException
		    Return CreateErrorResponse("JSON parsing error: " + err.Message)
		  End Try
		End Function
	#tag EndMethod

	#tag Method, Flags = &h21
		Private Function CreateErrorResponse(message As String) As Dictionary
		  Var result As New Dictionary
		  result.Value("status") = "error"
		  result.Value("message") = message

		  If AppConfig.DEBUG_MODE Then
		    System.DebugLog("APIClient error: " + message)
		  End If

		  Return result
		End Function
	#tag EndMethod
End Module
#tag EndModule


// ============================================================
// MODULE 3: AuthManager
// ============================================================
// Insert → Module, name it "AuthManager", paste this:

#tag Module
Protected Module AuthManager
	#tag Method, Flags = &h0
		Function Login(username As String, password As String) As Boolean
		  mLastError = ""

		  If username.Trim.Length = 0 Or password.Trim.Length = 0 Then
		    mLastError = "Username and password are required"
		    Return False
		  End If

		  Try
		    Var data As New Dictionary
		    data.Value("username") = username.Trim
		    data.Value("password") = password

		    Var result As Dictionary = APIClient.Post("auth.lc", "login", data)

		    If result.Value("status") = "success" Then
		      Var responseData As Dictionary = result.Value("data")

		      mCurrentToken = responseData.Value("token").StringValue

		      Var now As DateTime = DateTime.Now
		      mTokenExpiry = new DateTime(now.SecondsFrom1970 + (AppConfig.TOKEN_EXPIRY_MINUTES * 60))

		      If responseData.HasKey("user") Then
		        Var user As Dictionary = responseData.Value("user")
		        mCurrentUserID = user.Value("id").IntegerValue
		        mCurrentUsername = user.Value("username").StringValue
		        mCurrentUserEmail = user.Value("email").StringValue
		        If user.HasKey("name") Then
		          mCurrentUserName = user.Value("name").StringValue
		        End If
		      End If

		      mIsAuthenticated = True

		      If AppConfig.DEBUG_MODE Then
		        System.DebugLog("AuthManager: Login successful for " + mCurrentUsername)
		      End If

		      Return True

		    Else
		      mLastError = result.Value("message").StringValue
		      Return False
		    End If

		  Catch err As RuntimeException
		    mLastError = "Login error: " + err.Message
		    Return False
		  End Try
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Sub Logout()
		  mIsAuthenticated = False
		  mCurrentToken = ""
		  mTokenExpiry = Nil
		  mCurrentUserID = 0
		  mCurrentUsername = ""
		  mCurrentUserEmail = ""
		  mCurrentUserName = ""
		  mLastError = ""

		  If AppConfig.DEBUG_MODE Then
		    System.DebugLog("AuthManager: Logged out")
		  End If
		End Sub
	#tag EndMethod

	#tag Method, Flags = &h0
		Function GetAuthHeader() As String
		  If Not mIsAuthenticated Or mCurrentToken.Length = 0 Then
		    Return ""
		  End If

		  Return "Bearer " + mCurrentToken
		End Function
	#tag EndMethod

	#tag Property, Flags = &h21
		Private mIsAuthenticated As Boolean = False
	#tag EndProperty

	#tag Property, Flags = &h21
		Private mCurrentToken As String
	#tag EndProperty

	#tag Property, Flags = &h21
		Private mTokenExpiry As DateTime
	#tag EndProperty

	#tag Property, Flags = &h21
		Private mCurrentUserID As Integer
	#tag EndProperty

	#tag Property, Flags = &h21
		Private mCurrentUsername As String
	#tag EndProperty

	#tag Property, Flags = &h21
		Private mCurrentUserEmail As String
	#tag EndProperty

	#tag Property, Flags = &h21
		Private mCurrentUserName As String
	#tag EndProperty

	#tag Property, Flags = &h21
		Private mLastError As String
	#tag EndProperty

	#tag ComputedProperty, Flags = &h0
		#tag Getter
			Get
			  Return mIsAuthenticated
			End Get
		#tag EndGetter
		IsAuthenticated As Boolean
	#tag EndComputedProperty

	#tag ComputedProperty, Flags = &h0
		#tag Getter
			Get
			  Return mCurrentUserID
			End Get
		#tag EndGetter
		CurrentUserID As Integer
	#tag EndComputedProperty

	#tag ComputedProperty, Flags = &h0
		#tag Getter
			Get
			  Return mCurrentUsername
			End Get
		#tag EndGetter
		CurrentUsername As String
	#tag EndComputedProperty

	#tag ComputedProperty, Flags = &h0
		#tag Getter
			Get
			  Return mCurrentUserEmail
			End Get
		#tag EndGetter
		CurrentUserEmail As String
	#tag EndComputedProperty

	#tag ComputedProperty, Flags = &h0
		#tag Getter
			Get
			  Return mCurrentUserName
			End Get
		#tag EndGetter
		CurrentUserName As String
	#tag EndComputedProperty

	#tag ComputedProperty, Flags = &h0
		#tag Getter
			Get
			  Return mLastError
			End Get
		#tag EndGetter
		LastError As String
	#tag EndComputedProperty
End Module
#tag EndModule


// ============================================================
// TEST CODE: Paste into App.Opening event
// ============================================================

System.DebugLog "=========================================="
System.DebugLog "ECHO Indications API Test"
System.DebugLog "=========================================="
System.DebugLog ""

// Test 1: Connectivity
System.DebugLog "Test 1: Checking API connectivity..."
If APIClient.IsConnected Then
  System.DebugLog "✅ API is reachable"
Else
  System.DebugLog "❌ API is not reachable"
  Return
End If
System.DebugLog ""

// Test 2: List indications
System.DebugLog "Test 2: Fetching all indications..."
Var result As Dictionary = APIClient.Get("indications.lc", "list")

If result.Value("status") = "success" Then
  Var data As Dictionary = result.Value("data")

  If data.HasKey("indications") Then
    Var indicationsArray As Variant = data.Value("indications")

    If indicationsArray IsA Object() Then
      Var items() As Variant = Object()(indicationsArray)
      System.DebugLog "✅ Found " + items.Count.ToString + " indications"
      System.DebugLog ""

      System.DebugLog "First 5 indications:"
      For i As Integer = 0 To Min(4, items.Count - 1)
        If items(i) IsA Dictionary Then
          Var indication As Dictionary = Dictionary(items(i))
          Var id As Integer = indication.Value("id").IntegerValue
          Var title As String = indication.Value("title").StringValue
          System.DebugLog "  [" + id.ToString + "] " + title
        End If
      Next
    End If
  End If
Else
  System.DebugLog "❌ Error: " + result.Value("message").StringValue
End If
System.DebugLog ""

// Test 3: List contexts
System.DebugLog "Test 3: Fetching contexts..."
Var contextResult As Dictionary = APIClient.Get("contexts.lc", "with_counts")

If contextResult.Value("status") = "success" Then
  Var data As Dictionary = contextResult.Value("data")

  If data.HasKey("contexts") Then
    Var contextsArray As Variant = data.Value("contexts")

    If contextsArray IsA Object() Then
      Var items() As Variant = Object()(contextsArray)
      System.DebugLog "✅ Found " + items.Count.ToString + " contexts"
      System.DebugLog ""

      System.DebugLog "All contexts:"
      For i As Integer = 0 To items.Count - 1
        If items(i) IsA Dictionary Then
          Var context As Dictionary = Dictionary(items(i))
          Var name As String = context.Value("name").StringValue
          Var count As Integer = context.Value("indication_count").IntegerValue
          System.DebugLog "  • " + name + " (" + count.ToString + " indications)"
        End If
      Next
    End If
  End If
Else
  System.DebugLog "❌ Error: " + contextResult.Value("message").StringValue
End If
System.DebugLog ""

// Test 4: Search
System.DebugLog "Test 4: Searching for 'coronary'..."
Var params As New Dictionary
params.Value("q") = "coronary"
Var searchResult As Dictionary = APIClient.Get("search.lc", "keyword", params)

If searchResult.Value("status") = "success" Then
  Var data As Dictionary = searchResult.Value("data")

  If data.HasKey("results") Then
    Var resultsArray As Variant = data.Value("results")

    If resultsArray IsA Object() Then
      Var items() As Variant = Object()(resultsArray)
      System.DebugLog "✅ Found " + items.Count.ToString + " matching indications"

      For i As Integer = 0 To Min(2, items.Count - 1)
        If items(i) IsA Dictionary Then
          Var indication As Dictionary = Dictionary(items(i))
          Var title As String = indication.Value("title").StringValue
          System.DebugLog "  • " + title
        End If
      Next
    End If
  End If
Else
  System.DebugLog "❌ Error: " + searchResult.Value("message").StringValue
End If
System.DebugLog ""

System.DebugLog "=========================================="
System.DebugLog "All tests complete!"
System.DebugLog "=========================================="
