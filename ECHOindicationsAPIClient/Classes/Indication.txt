#tag Class
Protected Class Indication
	#tag Property, Flags = &h0
		ID As Integer
	#tag EndProperty

	#tag Property, Flags = &h0
		Title As String
	#tag EndProperty

	#tag Property, Flags = &h0
		Keywords As String
	#tag EndProperty

	#tag Property, Flags = &h0
		Comments As String
	#tag EndProperty

	#tag Property, Flags = &h0
		PrimaryCare As String
	#tag EndProperty

	#tag Property, Flags = &h0
		SecondaryInpatient As String
	#tag EndProperty

	#tag Property, Flags = &h0
		SecondaryOutpatient As String
	#tag EndProperty

	#tag Property, Flags = &h0
		SourceASE As Boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		SourceEACVI As Boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		SourceBSE As Boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		SourceConsensus As Boolean
	#tag EndProperty

	#tag Property, Flags = &h0
		Urgency As String
	#tag EndProperty

	#tag Property, Flags = &h0
		ContextIDs() As Integer
	#tag EndProperty

	#tag Property, Flags = &h0
		ContextNames() As String
	#tag EndProperty

	#tag Method, Flags = &h0
		Shared Function GetAll() As Indication()
		  '/// Fetches all indications from the API
		  '///
		  '/// @returns Array of Indication objects

		  Var results() As Indication

		  Try
		    Var response As Dictionary = APIClient.Get("indications.lc", "list")

		    If response.Value("status") = "success" Then
		      Var dataVariant As Variant = response.Value("data")
		      Var items() As Variant = dataVariant

		      For Each item As Variant In items
		        If item IsA Dictionary Then
		          Var indication As Indication = FromDictionary(Dictionary(item))
		          If indication <> Nil Then
		            results.Add(indication)
		          End If
		        End If
		      Next
		    Else
		      System.DebugLog("Indication.GetAll error: " + response.Value("message").StringValue)
		    End If

		  Catch err As RuntimeException
		    System.DebugLog("Indication.GetAll exception: " + err.Message)
		  End Try

		  Return results
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Shared Function GetByID(id As Integer) As Indication
		  '/// Fetches a single indication by ID
		  '///
		  '/// @param id The indication ID
		  '/// @returns Indication object or Nil if not found

		  Try
		    Var params As New Dictionary
		    params.Value("id") = id.ToString

		    Var response As Dictionary = APIClient.Get("indications.lc", "read", params)

		    If response.Value("status") = "success" Then
		      Var dataVariant As Variant = response.Value("data")

		      If dataVariant IsA Dictionary Then
		        Return FromDictionary(Dictionary(dataVariant))
		      End If
		    Else
		      System.DebugLog("Indication.GetByID error: " + response.Value("message").StringValue)
		    End If

		  Catch err As RuntimeException
		    System.DebugLog("Indication.GetByID exception: " + err.Message)
		  End Try

		  Return Nil
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Shared Function GetByContext(contextID As Integer) As Indication()
		  '/// Fetches all indications for a specific context
		  '///
		  '/// @param contextID The context ID to filter by
		  '/// @returns Array of Indication objects

		  Var results() As Indication

		  Try
		    Var params As New Dictionary
		    params.Value("context_id") = contextID.ToString

		    Var response As Dictionary = APIClient.Get("indications.lc", "list_by_context", params)

		    If response.Value("status") = "success" Then
		      Var dataVariant As Variant = response.Value("data")
		      Var items() As Variant = dataVariant

		      For Each item As Variant In items
		        If item IsA Dictionary Then
		          Var indication As Indication = FromDictionary(Dictionary(item))
		          If indication <> Nil Then
		            results.Add(indication)
		          End If
		        End If
		      Next
		    Else
		      System.DebugLog("Indication.GetByContext error: " + response.Value("message").StringValue)
		    End If

		  Catch err As RuntimeException
		    System.DebugLog("Indication.GetByContext exception: " + err.Message)
		  End Try

		  Return results
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Shared Function Search(keyword As String) As Indication()
		  '/// Searches for indications by keyword
		  '///
		  '/// @param keyword The search term
		  '/// @returns Array of matching Indication objects

		  Var results() As Indication

		  Try
		    Var params As New Dictionary
		    params.Value("keyword") = keyword

		    Var response As Dictionary = APIClient.Get("search.lc", "keyword", params)

		    If response.Value("status") = "success" Then
		      Var dataVariant As Variant = response.Value("data")
		      Var items() As Variant = dataVariant

		      For Each item As Variant In items
		        If item IsA Dictionary Then
		          Var indication As Indication = FromDictionary(Dictionary(item))
		          If indication <> Nil Then
		            results.Add(indication)
		          End If
		        End If
		      Next
		    Else
		      System.DebugLog("Indication.Search error: " + response.Value("message").StringValue)
		    End If

		  Catch err As RuntimeException
		    System.DebugLog("Indication.Search exception: " + err.Message)
		  End Try

		  Return results
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Function Delete() As Boolean
		  '/// Deletes this indication (requires authentication)
		  '///
		  '/// @returns True if successful, False otherwise

		  If Not AuthManager.IsAuthenticated Then
		    System.DebugLog("Indication.Delete: Not authenticated")
		    Return False
		  End If

		  Try
		    Var data As New Dictionary
		    data.Value("id") = ID

		    Var response As Dictionary = APIClient.Post("indications.lc", "delete", data)

		    If response.Value("status") = "success" Then
		      Return True
		    Else
		      System.DebugLog("Indication.Delete error: " + response.Value("message").StringValue)
		      Return False
		    End If

		  Catch err As RuntimeException
		    System.DebugLog("Indication.Delete exception: " + err.Message)
		    Return False
		  End Try
		End Function
	#tag EndMethod

	#tag Method, Flags = &h21
		Private Shared Function FromDictionary(data As Dictionary) As Indication
		  '/// Creates an Indication object from API response dictionary
		  '///
		  '/// @param data Dictionary from API
		  '/// @returns Indication object or Nil

		  Try
		    Var indication As New Indication

		    indication.ID = data.Value("id").IntegerValue
		    indication.Title = data.Value("title").StringValue

		    If data.HasKey("keywords") And data.Value("keywords") <> Nil Then
		      indication.Keywords = data.Value("keywords").StringValue
		    End If

		    If data.HasKey("comments") And data.Value("comments") <> Nil Then
		      indication.Comments = data.Value("comments").StringValue
		    End If

		    If data.HasKey("primary_care") And data.Value("primary_care") <> Nil Then
		      indication.PrimaryCare = data.Value("primary_care").StringValue
		    End If

		    If data.HasKey("secondary_inpatient") And data.Value("secondary_inpatient") <> Nil Then
		      indication.SecondaryInpatient = data.Value("secondary_inpatient").StringValue
		    End If

		    If data.HasKey("secondary_outpatient") And data.Value("secondary_outpatient") <> Nil Then
		      indication.SecondaryOutpatient = data.Value("secondary_outpatient").StringValue
		    End If

		    If data.HasKey("source_ase") Then
		      indication.SourceASE = (data.Value("source_ase").IntegerValue = 1)
		    End If

		    If data.HasKey("source_eacvi") Then
		      indication.SourceEACVI = (data.Value("source_eacvi").IntegerValue = 1)
		    End If

		    If data.HasKey("source_bse") Then
		      indication.SourceBSE = (data.Value("source_bse").IntegerValue = 1)
		    End If

		    If data.HasKey("source_consensus") Then
		      indication.SourceConsensus = (data.Value("source_consensus").IntegerValue = 1)
		    End If

		    If data.HasKey("urgency") And data.Value("urgency") <> Nil Then
		      indication.Urgency = data.Value("urgency").StringValue
		    End If

		    // Parse contexts if present
		    If data.HasKey("contexts") And data.Value("contexts") <> Nil Then
		      Try
		        Var contextsStr As String = data.Value("contexts").StringValue
		        If contextsStr.Length > 0 Then
		          indication.ContextNames = contextsStr.Split(",")
		        End If
		      Catch
		        // Ignore context parsing errors
		      End Try
		    End If

		    Return indication

		  Catch err As RuntimeException
		    System.DebugLog("Indication.FromDictionary error: " + err.Message)
		    Return Nil
		  End Try
		End Function
	#tag EndMethod

	#tag Method, Flags = &h0
		Function ToString() As String
		  '/// Returns a string representation of this indication
		  '///
		  '/// @returns String description

		  Var result As String = "[" + ID.ToString + "] " + Title

		  If Keywords.Length > 0 Then
		    result = result + " (Keywords: " + Keywords + ")"
		  End If

		  If ContextNames.Count > 0 Then
		    result = result + " {Contexts: " + String.FromArray(ContextNames, ", ") + "}"
		  End If

		  Return result
		End Function
	#tag EndMethod
End Class
#tag EndClass
